{"version":3,"file":"cli.js","sources":["../src/prog.js","../src/utils.js","../src/log-error.js","../src/cli.js"],"sourcesContent":["import sade from 'sade';\nlet { version } = require('../package');\n\nconst toArray = val => (Array.isArray(val) ? val : val == null ? [] : [val]);\n\nexport default handler => {\n\tconst ENABLE_MODERN = process.env.MICROBUNDLE_MODERN !== 'false';\n\n\tconst DEFAULT_FORMATS = ENABLE_MODERN ? 'modern,es,cjs,umd' : 'es,cjs,umd';\n\n\tconst cmd = type => (str, opts) => {\n\t\topts.watch = opts.watch || type === 'watch';\n\t\topts.compress =\n\t\t\topts.compress != null ? opts.compress : opts.target !== 'node';\n\t\topts.entries = toArray(str || opts.entry).concat(opts._);\n\t\thandler(opts);\n\t};\n\n\tlet prog = sade('microbundle');\n\n\tprog\n\t\t.version(version)\n\t\t.option('--entry, -i', 'Entry module(s)')\n\t\t.option('--output, -o', 'Directory to place build files into')\n\t\t.option(\n\t\t\t'--format, -f',\n\t\t\t`Only build specified formats (any of ${DEFAULT_FORMATS} or iife)`,\n\t\t\tDEFAULT_FORMATS,\n\t\t)\n\t\t.option('--watch, -w', 'Rebuilds on any change', false)\n\t\t.option(\n\t\t\t'--pkg-main',\n\t\t\t'Outputs files analog to package.json main entries',\n\t\t\ttrue,\n\t\t)\n\t\t.option('--target', 'Specify your target environment (node or web)', 'web')\n\t\t.option('--external', `Specify external dependencies, or 'none'`)\n\t\t.option('--globals', `Specify globals dependencies, or 'none'`)\n\t\t.example('microbundle --globals react=React,jquery=$')\n\t\t.option('--define', 'Replace constants with hard-coded values')\n\t\t.example('microbundle --define API_KEY=1234')\n\t\t.option('--alias', `Map imports to different modules`)\n\t\t.example('microbundle --alias react=preact')\n\t\t.option('--compress', 'Compress output using Terser', null)\n\t\t.option('--strict', 'Enforce undefined global context and add \"use strict\"')\n\t\t.option('--name', 'Specify name exposed in UMD builds')\n\t\t.option('--cwd', 'Use an alternative working directory', '.')\n\t\t.option('--sourcemap', 'Generate source map', true)\n\t\t.option(\n\t\t\t'--css-modules',\n\t\t\t'Turns on css-modules for all .css imports. Passing a string will override the scopeName. eg --css-modules=\"_[hash]\"',\n\t\t\tnull,\n\t\t)\n\t\t.example(\"microbundle --no-sourcemap # don't generate sourcemaps\")\n\t\t.option('--raw', 'Show raw byte size', false)\n\t\t.option(\n\t\t\t'--jsx',\n\t\t\t'A custom JSX pragma like React.createElement (default: h)',\n\t\t)\n\t\t.option('--tsconfig', 'Specify the path to a custom tsconfig.json')\n\t\t.example('microbundle build --tsconfig tsconfig.build.json');\n\n\tprog\n\t\t.command('build [...entries]', '', { default: true })\n\t\t.describe('Build once and exit')\n\t\t.action(cmd('build'));\n\n\tprog\n\t\t.command('watch [...entries]')\n\t\t.describe('Rebuilds on any change')\n\t\t.action(cmd('watch'));\n\n\t// Parse argv; add extra aliases\n\treturn argv =>\n\t\tprog.parse(argv, {\n\t\t\talias: {\n\t\t\t\to: ['output', 'd'],\n\t\t\t\ti: ['entry', 'entries', 'e'],\n\t\t\t\tw: ['watch'],\n\t\t\t},\n\t\t});\n};\n","import { promises as fs } from 'fs';\n\nexport const readFile = fs.readFile;\n\nexport const stat = fs.stat;\n\nexport const isDir = name =>\n\tstat(name)\n\t\t.then(stats => stats.isDirectory())\n\t\t.catch(() => false);\n\nexport const isFile = name =>\n\tstat(name)\n\t\t.then(stats => stats.isFile())\n\t\t.catch(() => false);\n\nexport const stdout = console.log.bind(console); // eslint-disable-line no-console\n\nexport const stderr = console.error.bind(console);\n\nexport const isTruthy = obj => {\n\tif (!obj) {\n\t\treturn false;\n\t}\n\n\treturn obj.constructor !== Object || Object.keys(obj).length > 0;\n};\n","import { red, dim } from 'kleur';\nimport { stderr } from './utils';\n\nexport default function(err) {\n\tconst error = err.error || err;\n\tconst description = `${error.name ? error.name + ': ' : ''}${error.message ||\n\t\terror}`;\n\tconst message = error.plugin\n\t\t? `(${error.plugin} plugin) ${description}`\n\t\t: description;\n\n\tstderr(red().bold(message));\n\n\tif (error.loc) {\n\t\tstderr();\n\t\tstderr(`at ${error.loc.file}:${error.loc.line}:${error.loc.column}`);\n\t}\n\n\tif (error.frame) {\n\t\tstderr();\n\t\tstderr(dim(error.frame));\n\t} else if (err.stack) {\n\t\tconst headlessStack = error.stack.replace(message, '');\n\t\tstderr(dim(headlessStack));\n\t}\n\n\tstderr();\n}\n","#!/usr/bin/env node\n\nimport microbundle from '.';\nimport prog from './prog';\nimport { stdout } from './utils';\nimport logError from './log-error';\n\nconst run = opts => {\n\tmicrobundle(opts)\n\t\t.then(output => {\n\t\t\tif (output != null) stdout(output);\n\t\t\tif (!opts.watch) process.exit(0);\n\t\t})\n\t\t.catch(err => {\n\t\t\tprocess.exitCode = (typeof err.code === 'number' && err.code) || 1;\n\t\t\tlogError(err);\n\t\t\tprocess.exit();\n\t\t});\n};\n\nprog(run)(process.argv);\n"],"names":["version","require","toArray","val","Array","isArray","handler","ENABLE_MODERN","process","env","MICROBUNDLE_MODERN","DEFAULT_FORMATS","cmd","type","str","opts","watch","compress","target","entries","entry","concat","_","prog","sade","option","example","command","default","describe","action","argv","parse","alias","o","i","w","stdout","console","log","bind","stderr","error","err","description","name","message","plugin","red","bold","loc","file","line","column","frame","dim","stack","headlessStack","replace","run","microbundle","then","output","exit","catch","exitCode","code","logError"],"mappings":"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"}